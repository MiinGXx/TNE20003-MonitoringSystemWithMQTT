<!DOCTYPE html>
<html>
    <head>
        <title>User 2 Dashboard</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        />
        <style>
            :root {
                --primary-color: #2196f3;
                --success-color: #4caf50;
                --danger-color: #f44336;
                --warning-color: #ff9800;
                --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            body {
                font-family: "Segoe UI", Arial, sans-serif;
                margin: 0;
                background-color: #f5f7fa;
                color: #333;
            }

            .container {
                display: grid;
                grid-template-columns: auto 250px;
                gap: 20px;
                max-width: 1200px;
                margin: 20px auto;
                padding: 20px;
            }

            .main-content {
                display: grid;
                gap: 20px;
            }

            .sidebar {
                background: white;
                padding: 20px;
                border-radius: 15px;
                box-shadow: var(--card-shadow);
            }

            .header {
                grid-column: 1 / -1;
                display: flex;
                align-items: center;
                justify-content: space-between;
                background: white;
                padding: 20px;
                border-radius: 15px;
                box-shadow: var(--card-shadow);
            }

            .header h1 {
                margin: 0;
                color: #1a1a1a;
            }

            .status-badge {
                display: flex;
                align-items: center;
                padding: 8px 16px;
                border-radius: 20px;
                background: #eee;
                font-size: 14px;
            }

            .status-indicator {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                margin-right: 8px;
                transition: background-color 0.3s ease;
            }

            .status-ok {
                background-color: var(--success-color);
            }
            .status-error {
                background-color: var(--danger-color);
            }

            .card {
                background: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: var(--card-shadow);
                transition: transform 0.2s, box-shadow 0.2s;
            }

            .card:hover {
                transform: translateY(-5px);
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            }

            .card h2 {
                margin-top: 0;
                color: #1a1a1a;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .value {
                font-size: 36px;
                font-weight: bold;
                color: var(--primary-color);
                margin: 15px 0;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
            }

            .value i {
                font-size: 24px;
            }

            .value.warning {
                color: var(--warning-color);
            }

            .value.danger {
                color: var(--danger-color);
            }

            .sidebar-section {
                margin-bottom: 20px;
            }

            .sidebar-section h3 {
                margin-top: 0;
                color: #666;
                font-size: 14px;
                text-transform: uppercase;
                letter-spacing: 1px;
            }

            .button {
                background: var(--primary-color);
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                transition: background-color 0.3s;
                width: 100%;
                margin-bottom: 10px;
            }

            .button:hover {
                background: #1976d2;
            }

            .button.disabled {
                background: #ccc;
                cursor: not-allowed;
            }
            @media (max-width: 768px) {
                .container {
                    grid-template-columns: 1fr;
                    grid-template-areas:
                        "header"
                        "sidebar"
                        "content";
                }

                .header {
                    grid-area: header;
                    flex-direction: column;
                    gap: 15px;
                    text-align: center;
                }

                .sidebar {
                    grid-area: sidebar;
                }

                .main-content {
                    grid-area: content;
                }

                .card {
                    padding: 20px;
                }
            }

            @keyframes pulse {
                0% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.05);
                }
                100% {
                    transform: scale(1);
                }
            }

            .value.update {
                animation: pulse 0.5s ease-in-out;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>User 2 Dashboard</h1>
                <div class="status-badge">
                    <span class="status-indicator" id="mqttStatus"></span>
                    MQTT Connection
                </div>
            </div>

            <div class="main-content">
                <div class="card">
                    <h2>
                        <i class="fas fa-thermometer-half"></i> Received
                        Temperature
                    </h2>
                    <div id="temperature" class="value">
                        <i class="fas fa-thermometer-half"></i>
                        <span>--°C</span>
                    </div>
                </div>

                <div class="card">
                    <h2><i class="fas fa-fan"></i> Cooling Status</h2>
                    <div id="cooling" class="value">
                        <i class="fas fa-power-off"></i>
                        <span>--</span>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="sidebar-section">
                    <h3>Manual Controls</h3>
                    <button class="button disabled" id="overrideBtn">
                        <i class="fas fa-shield-alt"></i> Manual Override
                    </button>
                    <button class="button disabled" id="fanSpeedBtn">
                        <i class="fas fa-tachometer-alt"></i> Fan Speed Control
                    </button>
                </div>

                <div class="sidebar-section">
                    <h3>System Status</h3>
                    <p>Future monitoring metrics will appear here</p>
                </div>
            </div>
        </div>

        <script>
            var socket = io();
            let lastTemp = 0;
            var currentThreshold = 25.0; // Will be updated by threshold_update events

            // Function to update temperature display based on current threshold
            function updateTemperatureDisplay(temp) {
                const tempElement = document.getElementById("temperature");
                const tempSpan = tempElement.querySelector("span");

                // Update value with animation
                tempSpan.textContent = temp + "°C";
                tempElement.classList.remove("update");
                void tempElement.offsetWidth; // Trigger reflow
                tempElement.classList.add("update");

                // Update color based on temperature compared to threshold
                console.log(
                    `Evaluating temp ${temp}°C against threshold ${currentThreshold}°C`
                );
                if (temp > currentThreshold + 2) {
                    tempElement.className = "value danger";
                } else if (temp > currentThreshold) {
                    tempElement.className = "value warning";
                } else {
                    tempElement.className = "value";
                }
            }

            socket.on("threshold_update", function (data) {
                const oldThreshold = currentThreshold;
                currentThreshold = parseFloat(data.threshold);
                console.log(
                    `Temperature threshold updated: ${oldThreshold}°C -> ${currentThreshold}°C`
                );

                // Re-evaluate current temperature against new threshold
                const tempElement = document.getElementById("temperature");
                const currentTemp = parseFloat(
                    tempElement.querySelector("span").textContent
                );
                if (!isNaN(currentTemp)) {
                    updateTemperatureDisplay(currentTemp);
                }
            });

            socket.on("temperature", function (data) {
                const temp = parseFloat(data.data);
                updateTemperatureDisplay(temp);
                lastTemp = temp;
            });

            socket.on("cooling_command", function (data) {
                const coolingElement = document.getElementById("cooling");
                const coolingSpan = coolingElement.querySelector("span");
                const coolingIcon = coolingElement.querySelector("i");

                coolingSpan.textContent = data.data;
                if (data.data === "ON") {
                    coolingElement.style.color = "#4CAF50";
                    coolingIcon.className = "fas fa-fan fa-spin";
                } else {
                    coolingElement.style.color = "#f44336";
                    coolingIcon.className = "fas fa-power-off";
                }

                coolingElement.classList.remove("update");
                void coolingElement.offsetWidth;
                coolingElement.classList.add("update");
            });

            socket.on("connect", function () {
                document.getElementById("mqttStatus").className =
                    "status-indicator status-ok";
            });

            socket.on("disconnect", function () {
                document.getElementById("mqttStatus").className =
                    "status-indicator status-error";
            });
        </script>
    </body>
</html>
